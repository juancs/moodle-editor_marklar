define(["jquery","core/yui","core/str","core/log","core/ajax","editor_marklar/filepicker"],function(a,b,c,d,e,f){"use strict";function g(a,b){this.initparams=b,"undefined"!=typeof M.editor_marklar.fpoptions[b.elementid]&&(this.initparams.filepickeroptions=M.editor_marklar.fpoptions[b.elementid]),this.initTextArea(a),this.initPanel(),this.initFilesEmbedding(),this.initPreview()}return g.prototype.initTextArea=function(a){this.textarea=a.removeAttr("cols").addClass("marklar-textarea"),this.textarea.parent().parent().addClass("marklar-wrapper")},g.prototype.initPanel=function(){this.panel=this.textarea.parent().next();var a='select[name="'+this.textarea.attr("name").replace("[text]","[format]")+'"]';this.formatSelector=this.panel.find(a),this.formatSelector.length?this.formatSelector.attr("data-marklar-widget","format-select"):this.formatSelector=null,this.panel.append('<span data-marklar-placeholder="preview" />'),this.panel.append('<span data-marklar-placeholder="insert-image" />'),this.panel.append('<span data-marklar-placeholder="insert-file" />')},g.prototype.initFilesEmbedding=function(){if(!("filepickeroptions"in this.initparams))return void d.error(this.initparams.elementid+": File picker options not found");var e=this;b.use("core_filepicker",function(){e.filepicker=f.init(e.initparams.filepickeroptions),e.filepicker.canShowFilepicker("image")&&c.get_string("insertimage","editor_marklar").done(function(b){var c=a('<button data-marklar-widget="insert-image" />');c.text(b),c.click(function(a){a.preventDefault(),e.filepicker.showFilepicker("image",function(a){e.imageEmbedded(a)})}),e.panel.find('[data-marklar-placeholder="insert-image"]').replaceWith(c),e.insertImageButton=c}),e.filepicker.canShowFilepicker("link")&&c.get_string("insertlink","editor_marklar").done(function(b){var c=a('<button data-marklar-widget="insert-file" />');c.text(b),c.click(function(a){a.preventDefault(),e.filepicker.showFilepicker("link",function(a){e.insertLink(a)})}),e.panel.find('[data-marklar-placeholder="insert-file"]').replaceWith(c),e.insertFileButton=c})})},g.prototype.initPreview=function(){var b=this;b.formatSelector&&(b.previewBody=a('<div class="marklar-preview" />').hide(),b.panel.before(b.previewBody),c.get_strings([{key:"previewon",component:"editor_marklar"},{key:"previewoff",component:"editor_marklar"}]).then(function(c){b.previewButtonOn=a('<button data-marklar-widget="preview" />').text(c[0]).on("click",b.previewOn.bind(b)),b.previewButtonOff=a("<button>").text(c[1]).on("click",b.previewOff.bind(b)).hide();var d=a('<div class="marklar-preview-controls" />').append(b.previewButtonOn).append(b.previewButtonOff);b.panel.find('[data-marklar-placeholder="preview"]').replaceWith(d)}))},g.prototype.previewOn=function(a){var b=this;a.preventDefault(),c.get_string("previewloading","editor_marklar").then(function(a){b.previewButtonOn.hide(),b.previewButtonOff.show(),b.formatSelector&&b.formatSelector.attr("disabled","disabled"),b.insertImageButton&&b.insertImageButton.attr("disabled","disabled"),b.insertFileButton&&b.insertFileButton.attr("disabled","disabled"),b.previewBody.html('<div class="marklar-preview-loading">'+a+"</div>"),b.previewBody.height(b.textarea.height()),b.textarea.hide(),b.previewBody.show(),b.previewLoad()})},g.prototype.previewOff=function(a){var b=this;a.preventDefault(),b.previewButtonOff.hide(),b.previewButtonOn.show(),b.formatSelector&&b.formatSelector.removeAttr("disabled"),b.insertImageButton&&b.insertImageButton.removeAttr("disabled"),b.insertFileButton&&b.insertFileButton.removeAttr("disabled"),b.previewBody.hide(),b.previewBody.html(""),b.textarea.show()},g.prototype.previewLoad=function(){var a=this,b={text:a.textarea.val(),format:a.formatSelector.val(),contextid:a.initparams.contextid};return e.call([{methodname:"editor_marklar_get_preview",args:b}])[0].fail(function(b){a.previewBody.html('<div class="alert alert-error"><b>Error:</b> '+b.message+"</div>"),d.error(b)}).then(function(b){a.previewBody.html(b.html)})},g.prototype.imageEmbedded=function(a){"url"in a&&this.insertText('<img alt="" class="img-responsive" src="'+a.url+'"/>')},g.prototype.insertLink=function(a){if("url"in a){var b;b="file"in a&&a.file?a.file.replace(/(\[|\])/g,"_"):"texttoshow",this.insertText("["+b+"]("+a.url+")")}},g.prototype.insertText=function(a){this.textarea.val(this.textarea.val()+"\n\n"+a)},{init:function(b){var c;if(!("elementid"in b))throw new Error("editor_marklar: Invalid editor init parameter - missing elementid");if(c=a(document.getElementById(b.elementid)),!c.parents("form.mform").length||!c.parents('[data-fieldtype="editor"]').length)return void d.debug("marklar "+b.elementid+": not a nice neighborhood for me!");if(c.length)return new g(c,b);throw new Error("Unable to find textarea element",b.elementid)}}});