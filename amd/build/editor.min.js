define(["jquery","core/yui","core/str","core/log","core/ajax","editor_marklar/filepicker"],function(a,b,c,d,e,f){"use strict";function g(a,b){this.initparams=b,"undefined"!=typeof M.editor_marklar.fpoptions[b.elementid]&&(this.initparams.filepickeroptions=M.editor_marklar.fpoptions[b.elementid]),this.initTextArea(a),this.initFormatSelector(),this.initPanel(),this.initFilesEmbedding(),this.initPreview()}return g.prototype.initTextArea=function(a){var b=this;b.textarea=a.removeAttr("cols").addClass("marklar-textarea").css("box-sizing","border-box").css("width","100%").css("background-color","white").css("margin-bottom","10px").css("padding","7px")},g.prototype.initFormatSelector=function(){var b=this,e=b.textarea.attr("name").replace("[text]","[format]"),f=b.textarea.closest("form");if(e!==b.textarea.attr("name")&&(b.formatSelector=f.find('select[name="'+e+'"]'),!b.formatSelector.length)){var g,h,i=f.find('input[name="'+e+'"]');if(!i.length)return void d.error("marklar: format field not found: "+e);switch(g=parseInt(i.attr("value"))){case 0:h="formattext";break;case 1:h="formathtml";break;case 2:h="formatplain";break;case 4:h="formatmarkdown";break;default:return d.error("marklar: unknown text format "+g),void(b.formatSelector=null)}b.formatSelector=a('<select class="custom-select" name="'+e+'"></select>').append(a('<option value="'+g+'">'+h+"</option>")),i.remove(),c.get_string(h,"core_moodle").done(function(a){b.formatSelector.find('option[value="'+g+'"]').text(a)}).fail(function(a){d.error(a)})}},g.prototype.initPanel=function(){var b=this;b.textarea.wrap('<div class="marklar-wrapper"></div>'),b.panel=a('<div class="marklar-panel"></div>').insertAfter(b.textarea),b.formatSelector&&(b.panel.append(b.formatSelector),b.formatSelector.attr("data-marklar-widget","format-select")),b.panel.append('<span data-marklar-placeholder="preview" />'),b.panel.append('<span data-marklar-placeholder="insert-image" />'),b.panel.append('<span data-marklar-placeholder="insert-file" />')},g.prototype.initFilesEmbedding=function(){if(!("filepickeroptions"in this.initparams))return void d.error(this.initparams.elementid+": File picker options not found");var e=this;b.use("core_filepicker",function(){e.filepicker=f.init(e.initparams.filepickeroptions),e.filepicker.canShowFilepicker("image")&&c.get_string("insertimage","editor_marklar").done(function(b){var c=a('<button class="btn btn-default" data-marklar-widget="insert-image" />');c.text(b),c.click(function(a){a.preventDefault(),e.filepicker.showFilepicker("image",function(a){e.imageEmbedded(a)})}),e.panel.find('[data-marklar-placeholder="insert-image"]').replaceWith(c),e.insertImageButton=c}),e.filepicker.canShowFilepicker("link")&&c.get_string("insertlink","editor_marklar").done(function(b){var c=a('<button class="btn btn-default" data-marklar-widget="insert-file" />');c.text(b),c.click(function(a){a.preventDefault(),e.filepicker.showFilepicker("link",function(a){e.insertLink(a)})}),e.panel.find('[data-marklar-placeholder="insert-file"]').replaceWith(c),e.insertFileButton=c})})},g.prototype.initPreview=function(){var b=this;b.formatSelector&&(b.previewBody=a('<div class="marklar-preview" />').hide(),b.panel.before(b.previewBody),c.get_strings([{key:"previewon",component:"editor_marklar"},{key:"previewoff",component:"editor_marklar"}]).then(function(c){b.previewButtonOn=a('<button class="btn btn-default" data-marklar-widget="preview" />').text(c[0]).on("click",b.previewOn.bind(b)),b.previewButtonOff=a('<button class="btn btn-default">').text(c[1]).on("click",b.previewOff.bind(b)).hide();var d=a('<div class="marklar-preview-controls" />').append(b.previewButtonOn).append(b.previewButtonOff);b.panel.find('[data-marklar-placeholder="preview"]').replaceWith(d)}))},g.prototype.previewOn=function(a){var b=this;a.preventDefault(),c.get_string("previewloading","editor_marklar").then(function(a){b.previewButtonOn.hide(),b.previewButtonOff.show(),b.formatSelector&&b.formatSelector.attr("disabled","disabled"),b.insertImageButton&&b.insertImageButton.attr("disabled","disabled"),b.insertFileButton&&b.insertFileButton.attr("disabled","disabled"),b.previewBody.html('<div class="marklar-preview-loading">'+a+"</div>"),b.previewBody.height(b.textarea.height()),b.textarea.hide(),b.previewBody.show(),b.previewLoad()})},g.prototype.previewOff=function(a){var b=this;a.preventDefault(),b.previewButtonOff.hide(),b.previewButtonOn.show(),b.formatSelector&&b.formatSelector.removeAttr("disabled"),b.insertImageButton&&b.insertImageButton.removeAttr("disabled"),b.insertFileButton&&b.insertFileButton.removeAttr("disabled"),b.previewBody.hide(),b.previewBody.html(""),b.textarea.show()},g.prototype.previewLoad=function(){var a=this,b={text:a.textarea.val(),format:a.formatSelector.val(),contextid:a.initparams.contextid};return e.call([{methodname:"editor_marklar_get_preview",args:b}])[0].fail(function(b){a.previewBody.html('<div class="alert alert-error"><b>Error:</b> '+b.message+"</div>"),d.error(b)}).then(function(b){a.previewBody.html(b.html)})},g.prototype.imageEmbedded=function(a){"url"in a&&this.insertText('<img alt="" class="img-responsive" src="'+a.url+'"/>')},g.prototype.insertLink=function(a){if("url"in a){var b;b="file"in a&&a.file?a.file.replace(/(\[|\])/g,"_"):"texttoshow",this.insertText("["+b+"]("+a.url+")")}},g.prototype.insertText=function(a){this.textarea.val(this.textarea.val()+"\n\n"+a)},{init:function(b){var c;if(!("elementid"in b))throw new Error("editor_marklar: Invalid editor init parameter - missing elementid");if(c=a(document.getElementById(b.elementid)),c.length)return new g(c,b);throw new Error("Unable to find textarea element",b.elementid)}}});