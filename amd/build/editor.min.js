define(["jquery","core/yui","core/str","core/log","editor_marklar/filepicker"],function(a,b,c,d,e){"use strict";function f(a,b){this.initparams=b,"undefined"!=typeof M.editor_marklar.fpoptions[b.elementid]&&(this.initparams.filepickeroptions=M.editor_marklar.fpoptions[b.elementid]),this.initTextArea(a),this.initPanel(),this.initFilesEmbedding(),this.initPreview()}return f.prototype.initTextArea=function(a){this.textarea=a.removeAttr("cols").addClass("marklar-textarea"),this.textarea.parent().parent().addClass("marklar-wrapper")},f.prototype.initPanel=function(){this.panel=this.textarea.parent().next(),this.panel.append('<span data-marklar-placeholder="insert-image" />'),this.panel.append('<span data-marklar-placeholder="insert-file" />'),this.panel.append('<span data-marklar-placeholder="preview" />')},f.prototype.initFilesEmbedding=function(){if(!("filepickeroptions"in this.initparams))return void console.error(this.initparams.elementid+": File picker options not found");var d=this;b.use("core_filepicker",function(){d.filepicker=e.init(d.initparams.filepickeroptions),d.filepicker.canShowFilepicker("image")&&c.get_string("insertimage","editor_marklar").done(function(b){var c=a("<button/>");c.text(b),c.click(function(a){a.preventDefault(),d.filepicker.showFilepicker("image",function(a){d.imageEmbedded(a)})}),d.panel.find('[data-marklar-placeholder="insert-image"]').replaceWith(c)}),d.filepicker.canShowFilepicker("link")&&c.get_string("insertlink","editor_marklar").done(function(b){var c=a("<button/>");c.text(b),c.click(function(a){a.preventDefault(),d.filepicker.showFilepicker("link",function(a){d.insertLink(a)})}),d.panel.find('[data-marklar-placeholder="insert-file"]').replaceWith(c)})})},f.prototype.initPreview=function(){var b=this;b.previewBody=a('<div class="marklar-preview" />').hide(),b.panel.before(b.previewBody),c.get_strings([{key:"previewon",component:"editor_marklar"},{key:"previewoff",component:"editor_marklar"}]).then(function(c){b.previewButtonOn=a("<button>").text(c[0]).on("click",b.previewOn.bind(b)),b.previewButtonOff=a("<button>").text(c[1]).on("click",b.previewOff.bind(b)).hide();var d=a('<div class="marklar-preview-controls" />').append(b.previewButtonOn).append(b.previewButtonOff);b.panel.find('[data-marklar-placeholder="preview"]').replaceWith(d)})},f.prototype.previewOn=function(a){var b=this;a.preventDefault(),c.get_string("previewloading","editor_marklar").then(function(a){b.previewButtonOn.hide(),b.previewButtonOff.show(),b.previewBody.html('<div class="marklar-preview-loading">'+a+"</div>"),b.previewBody.height(b.textarea.height()),b.textarea.hide(),b.previewBody.show()})},f.prototype.previewOff=function(a){var b=this;a.preventDefault(),b.previewButtonOff.hide(),b.previewButtonOn.show(),b.previewBody.hide(),b.textarea.show()},f.prototype.imageEmbedded=function(a){"url"in a&&this.insertText('<img alt="" class="img-responsive" src="'+a.url+'"/>')},f.prototype.insertLink=function(a){if("url"in a){var b;b="file"in a&&a.file?a.file.replace(/(\[|\])/g,"_"):"texttoshow",this.insertText("["+b+"]("+a.url+")")}},f.prototype.insertText=function(a){this.textarea.val(this.textarea.val()+"\n\n"+a)},{init:function(b){var c;if(!("elementid"in b))throw new Error("editor_marklar: Invalid editor init parameter - missing elementid");if(c=a(document.getElementById(b.elementid)),c.length)return new f(c,b);throw new Error("Unable to find textarea element",b.elementid)}}});